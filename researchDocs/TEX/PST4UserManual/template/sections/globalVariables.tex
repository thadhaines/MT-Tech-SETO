%===========================================================================================================
\pagebreak
\section{Global Variable Management  - WIP}  
Previous versions of PST rely on the use of over 340 global variables.
It was decided to create a global structure that contains all exiting globals to enable easier development and use of PST.
%While this may or may not have been a good idea - it happened.
After global restructuring, initial simulation results showed a speed up of over 2 times.
In other words, it could be assumed previous versions of PST spent half of their computation time handling globals.


Inside the global variable \verb|g| are fields that corresponds to models, or groups, of other globals.
Essentially, globals defined in the \verb|pst_var| script were collected into related fields.
For example, the \verb|g.mac.mac_spd| global contains a all machine speeds while the \verb|g.bus.bus_v| contains all bus voltages, etc.
The following subsections describe the globals contained in each field of the global \verb|g|. 
Consult \cite{PST3manual} for a description of what most global variables represent.


%---------------------------------------------------------------------------------------------------
\subsection{agc - WIP}  
This field contains variables related to AGC models, calculations, and operations.
An example of AGC variables are shown below

\begin{minted}{MATLAB}
>> g.agc
ans = 
      agc: [1x2 struct]
    n_agc: 2
do better
\end{minted}

%---------------------------------------------------------------------------------------------------
\subsection{area - WIP}  
This field contains variables for area calculations and operations.
An example of area variables are shown below.
\begin{minted}{MATLAB}
>> g.area
ans = 
    area_def: [13x2 double]
      n_area: 2
        area: [1x2 struct]
>> g.area.area(1)
do better
\end{minted}

%---------------------------------------------------------------------------------------------------
\subsection{bus - WIP}  
The \verb|g.bus| field contains the user supplied \verb|bus| array and all altered bus arrays associated with faults created in \verb|y_switch|.
The bus field also contains the \verb|bus_v| and \verb|theta| information related to buses.


%---------------------------------------------------------------------------------------------------
\subsection{dc}
This field contains variables for DC models, calculations, and operations.
\begin{minted}{MATLAB}
%% HVDC link variables 
global dcsp_con  dcl_con  dcc_con
global r_idx  i_idx n_dcl  n_conv  ac_bus rec_ac_bus  inv_ac_bus
global inv_ac_line  rec_ac_line ac_line dcli_idx
global tap tapr tapi tmax tmin tstep tmaxr tmaxi tminr tmini tstepr tstepi
global Vdc  i_dc P_dc i_dcinj dc_pot alpha gamma 
global VHT dc_sig  cur_ord dcr_dsig dci_dsig
global ric_idx  rpc_idx Vdc_ref dcc_pot
global no_cap_idx  cap_idx  no_ind_idx  l_no_cap  l_cap
global ndcr_ud ndci_ud dcrud_idx dciud_idx dcrd_sig dcid_sig
%% States
%line
global i_dcr i_dci  v_dcc
global di_dcr  di_dci  dv_dcc
global dc_dsig % added 07/13/20 -thad
%rectifier
global v_conr dv_conr
%inverter
global v_coni dv_coni
% added to global dc
global xdcr_dc dxdcr_dc xdci_dc dxdci_dc angdcr angdci t_dc
global dcr_dc dci_dc % damping control
global ldc_idx
global rec_par inv_par line_par
\end{minted}

Some DC related functions reused global variable names for local values but avoided conflict by not importing the specific globals.
During global conversion, this coding approach caused some issues with accidental casting to global and overwriting issues.
While the non-linear and linear simulations run, there may be issues with this problem yet to be discovered.
More specifically, the \verb|tap| variable is re-written numerous times during a simulation when calculating line flows.



%---------------------------------------------------------------------------------------------------
\subsection{exc}
This field contains variables for exciter models, calculations, and operations.
\begin{minted}{MATLAB}
%% Exciter variables
global exc_con exc_pot n_exc
global Efd V_R V_A V_As R_f V_FB V_TR V_B
global dEfd dV_R dV_As dR_f dV_TR
global exc_sig 
global smp_idx n_smp dc_idx n_dc  dc2_idx n_dc2 st3_idx n_st3
global smppi_idx n_smppi smppi_TR smppi_TR_idx smppi_no_TR_idx 
global smp_TA smp_TA_idx smp_noTA_idx smp_TB smp_TB_idx smp_noTB_idx
global smp_TR smp_TR_idx smp_no_TR_idx 
global dc_TA dc_TA_idx dc_noTR_idx dc_TB dc_TB_idx dc_noTB_idx
global dc_TE  dc_TE_idx dc_noTE_idx
global dc_TF dc_TF_idx dc_TR dc_TR_idx
global st3_TA st3_TA_idx st3_noTA_idx st3_TB st3_TB_idx st3_noTB_idx
global st3_TR st3_TR_idx st3_noTR_idx
\end{minted}

%---------------------------------------------------------------------------------------------------
\subsection{igen}
This field contains variables for induction generator models, calculations, and operations.
\begin{minted}{MATLAB}
%% induction genertaor variables 
global tmig  pig qig vdig vqig  idig iqig igen_con igen_pot
global igen_int igbus n_ig
%states
global  vdpig vqpig slig
%dstates
global dvdpig dvqpig dslig
% added globals
global s_igen
\end{minted}


%---------------------------------------------------------------------------------------------------
\subsection{ind}
This field contains variables for induction motor models, calculations, and operations.
\begin{minted}{MATLAB}
%% induction motor variables
global  tload t_init p_mot q_mot vdmot vqmot idmot iqmot ind_con ind_pot
global  motbus ind_int mld_con n_mot t_mot
% states
global  vdp vqp slip
% dstates
global dvdp dvqp dslip
% added globals
global s_mot
global sat_idx dbc_idx db_idx % has to do with version 2 of mac_ind
% changed all pmot to p_mot (mac_ind1 only)
\end{minted}

Two models of this are included as \verb|mac_ind1| (a basic version from 2.3), and \verb|mac_ind2| which is an updated induction motor model. Default behavior is to use the newer model (\verb|mac_ind2|).

%---------------------------------------------------------------------------------------------------
\subsection{ivm - WIP} 
voltage model...
\begin{minted}{MATLAB}
get the tstuff
\end{minted}

%---------------------------------------------------------------------------------------------------
\subsection{k}  
To allow for functionalized running, various index values were placed into the global structure in the \verb|g.k| field

\begin{minted}{MATLAB}
global k_inc h ks h_sol
golbal k_incdc h_dc
\end{minted}

%---------------------------------------------------------------------------------------------------
\subsection{line}  
The \verb|g.line| field contains the user supplied \verb|line| array and all altered line arrays associated with faults created in \verb|y_switch|.

%---------------------------------------------------------------------------------------------------
\subsection{lmod}
This field contains variables for real load modulation models, calculations, and operations.
\begin{minted}{MATLAB}
global lmod_con % defined by user
global n_lmod lmod_idx % initialized and created in lm_indx
global lmod_sig lmod_st dlmod_st % initialized in s_simu
global lmod_pot  % created/initialized in lmod.m 
global lmod_data % added by Trudnowski - doesn't appear to be used
\end{minted}

%---------------------------------------------------------------------------------------------------
\subsection{lmon - WIP}  
This field contains variables for line monitoring not previously collected during simulation.
An example of lmon contents is shown below.
\begin{minted}{MATLAB}
>> g.lmon
ans = 

do better
\end{minted}

%---------------------------------------------------------------------------------------------------
\subsection{mac}
This field contains variables for machine models, calculations, and operations.
\begin{minted}{MATLAB}
global mac_con mac_pot mac_int ibus_con
global mac_ang mac_spd eqprime edprime psikd psikq
global curd curq curdg curqg fldcur
global psidpp psiqpp vex eterm ed eq
global pmech pelect qelect
global dmac_ang dmac_spd deqprime dedprime dpsikd dpsikq
global n_mac n_em n_tra n_sub n_ib
global mac_em_idx mac_tra_idx mac_sub_idx mac_ib_idx not_ib_idx
global mac_ib_em mac_ib_tra mac_ib_sub n_ib_em n_ib_tra n_ib_sub
global pm_sig n_pm 
global psi_re psi_im cur_re cur_im
% added
global mac_trip_flags
global mac_trip_states
\end{minted}

%---------------------------------------------------------------------------------------------------
\subsection{ncl}
This field contains variables for non-conforming load models, calculations, and operations.
\begin{minted}{MATLAB}
global  load_con load_pot nload
\end{minted}

%---------------------------------------------------------------------------------------------------
\subsection{pss}
This field contains variables for power system stabilizer models, calculations, and operations.
\begin{minted}{MATLAB}
global pss_con pss_pot pss_mb_idx pss_exc_idx
global pss1 pss2 pss3 dpss1 dpss2 dpss3 pss_out
global pss_idx n_pss pss_sp_idx pss_p_idx;
global pss_T  pss_T2 pss_T4 pss_T4_idx  
global pss_noT4_idx % misspelled in pss_indx as pss_noT4
\end{minted}
Despite the renaming of the \verb|pss_noT4_idx|, it doesn't seem to actually be used anywhere.


%---------------------------------------------------------------------------------------------------
\subsection{pwr}
This field contains variables for power or current injection models, calculations, and operations that use the \verb|pwrmod| model.
\begin{minted}{MATLAB}
global pwrmod_con n_pwrmod pwrmod_idx
global pwrmod_p_st dpwrmod_p_st
global pwrmod_q_st dpwrmod_q_st
global pwrmod_p_sig pwrmod_q_sig
global pwrmod_data
\end{minted}


%---------------------------------------------------------------------------------------------------
\subsection{rlmod}
This field contains variables for reactive load modulation models, calculations, and operations.
\begin{minted}{MATLAB}
global rlmod_con n_rlmod rlmod_idx
global rlmod_pot rlmod_st drlmod_st
global rlmod_sig
\end{minted}

%---------------------------------------------------------------------------------------------------
\subsection{svc}
This field contains variables for static VAR control system models, calculations, and operations.
\begin{minted}{MATLAB}
global svc_con n_svc svc_idx svc_pot svcll_idx
global svc_sig
% svc user defined damping controls
global n_dcud dcud_idx svc_dsig
global svc_dc % user damping controls?
global dxsvc_dc xsvc_dc
%states
global B_cv B_con
%dstates
global dB_cv dB_con
\end{minted}

There seems to be code related to user defined damping control of SVC, but it does not seem to be described in any available documentation. 
This damping functionality was added by Graham Rogers circa 1998/1999.


%---------------------------------------------------------------------------------------------------
\subsection{sys}
This field contains variables that deal with simulation operations.
\begin{minted}{MATLAB}
global basmva basrad syn_ref mach_ref sys_freq
% globals added
global sw_con livePlotFlag Fbase t t_OLD
global aveF totH
global ElapsedNonLinearTime clearedVars
\end{minted}

%---------------------------------------------------------------------------------------------------
\subsection{tcsc}
This field contains variables for thyristor controlled series reactor models, calculations, and operations.
\begin{minted}{MATLAB}
global tcsc_con n_tcsc tcsvf_idx tcsct_idx
global B_tcsc dB_tcsc
global tcsc_sig tcsc_dsig
global n_tcscud dtcscud_idx  %user defined damping controls
% previous non-globals added as they seem to relavant
global xtcsc_dc dxtcsc_dc td_sig tcscf_idx 
global tcsc_dc
\end{minted}

Similar to the SVC model, there seems to be some added functionality for controlled damping, but no examples or previous documentation could be found.
This damping functionality was added by Graham Rogers circa 1998/1999.

%---------------------------------------------------------------------------------------------------
\subsection{tg}
This field contains variables for turbine governor models, calculations, and operations.
\begin{minted}{MATLAB}
%% turbine-governor variables
global tg_con tg_pot
global tg1 tg2 tg3 tg4 tg5 dtg1 dtg2 dtg3 dtg4 dtg5
global tg_idx  n_tg tg_sig tgh_idx n_tgh
\end{minted}

It should be noted that the hydro governor model \verb|tgh| has not been modified as no examples could be found that use it.

%---------------------------------------------------------------------------------------------------
\subsection{vts}  
Globals associated with variable time step simulation runs were placed in the \verb|g.vts| field.
A description of the included variables is shown below.

\begin{minted}{MATLAB}
dataN       % Used as a the data index for logging values
dxVec       % Vector used to collect current dataN derivatives
fsdn        % A cell of fields, states, derivatives, and number of states
fts         % Cell containing any fixed step time vectors
fts_dc      % Cell containing any fixed step time vectors for DC simulation
iter        % Counter to monitor number of solutions per step
n_states    % Total system state count
netSlnCell  % Similar to fsdn, but related to netowrk variables
netSlnVec   % Vector used to store initial network solution results
options     % MATLAB ODE solver options
slns        % A running history of solution iterations per step
solver_con  % User defined array defining what solution method to use
stVec       % Vector used to collect current dataN states
t_block     % A list of time blocks collected from sw_con
t_blockN    % Current time block index being executed
tot_iter    % Total number of solutions
\end{minted}

%---------------------------------------------------------------------------------------------------
\subsection{y - WIP}  
Contains reduced Y matrices, voltage recovery matrcies, and bus order variables created in \verb|y_switch| associated with faults.
Example variables are shown below.
\begin{minted}{MATLAB}
>> g.int
ans = 
      Y_gprf: [4x4 double]
do better....
\end{minted}

%---------------------------------------------------------------------------------------------------
\begin{comment}

template for subparagraphs

%---------------------------------------------------------------------------------------------------
\subsection{xxx} %  
\begin{minted}{MATLAB}

\end{minted}

\end{comment}